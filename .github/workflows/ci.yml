name: Aquil Symbolic Engine CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Nightly run at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  guardrails:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run all guard checks
      run: npm run guard
      
    - name: Check operation count (must be 30)
      run: |
        OP_COUNT=$(jq '[.paths[]|.[]|select(.operationId)]|length' gpt-actions-schema.json)
        echo "Operation count: $OP_COUNT"
        if [ "$OP_COUNT" != "30" ]; then
          echo "‚ùå Operation count must be exactly 30, found $OP_COUNT"
          exit 1
        fi
        echo "‚úÖ Operation count is correct (30)"
      
    - name: Run embedding hygiene tests
      run: node --test test/embeddingHygiene.test.js
      
    - name: Test reconcile script (dry run)
      run: npm run reconcile -- --window 1 --dry-run

  tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run all tests
      run: npm run test
      env:
        # Mirror wrangler.toml binding names for test environment
        AQUIL_DB: "test-db"
        AQUIL_MEMORIES: "test-memories" 
        AQUIL_CONTEXT: "test-context"
        AQUIL_STORAGE: "test-storage"

  acceptance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run acceptance tests
      run: npm run accept
      env:
        # Test environment bindings
        AQUIL_DB: "test-db"
        AQUIL_MEMORIES: "test-memories"
        AQUIL_CONTEXT: "test-context" 
        AQUIL_STORAGE: "test-storage"
        ACCEPTANCE_URL: "http://localhost:8787"
        
  schema-diff:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for git diff
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Generate spec diff
      run: |
        echo "## üìã OpenAPI Schema Diff" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        npm run spec:diff >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
        
    - name: Verify no uncommitted schema changes
      run: |
        if ! git diff --exit-code gpt-actions-schema.json; then
          echo "‚ùå Schema changes detected but not committed"
          echo "Run 'npm run spec:bump' to update version and commit changes"
          exit 1
        fi
        echo "‚úÖ Schema changes are properly committed"